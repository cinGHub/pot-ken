---
title: "POT-KEN"
format: gfm
editor: visual
---

# Pot-ken v1.3.0

*Heat* / calor in Selk'nam language

*A reproducible R workflow for energy density estimation using a Parr 6725 calorimeter*

Flujo de trabajo reproducible en R para la estimación de densidad energética mediante un calorímetro Parr 672**5**

Developed by [Cintia Fraysse](https://www.researchgate.net/profile/Cintia-Fraysse?ev=hdr_xprf) and [Claudia Boy](https://www.researchgate.net/profile/Claudia-Boy) in [Laboratorio de Ecología, Fisiología y Evolución de Organismos Acuáticos](https://www.researchgate.net/lab/Ecologia-Fisiologia-y-Evolucion-de-Organismos-Acuaticos-Daniel-A-Fernandez)

Licence information at the end of this file.\
\
POT-KEN/

├── POT-KEN.Rproj

├── Determinations/ *#empty by default – user input* /vacía - cargar los archivos generados por el equipo

├── Example/ *#example dataset for demonstration*/solo para Usage example

├── R/

│ └── potken_workflow.R

└── README.qmd

## **Overview of the workflow/Descripción general del flujo de trabajo**

### English

This workflow provides a fully reproducible R-based approach to process raw output files generated by a Parr 6725 bomb calorimeter.

The code automatically:

-   assigns column names to calorimeter output files using the `RunDataTemplate.csv` file,

-   compiles all individual determinations into a single dataset,

-   removes non-essential variables,

-   converts binary and numeric codes into their corresponding descriptive labels, and

-   calculates energy density values corrected and uncorrected for ash content.

### Español

Este flujo de trabajo proporciona un enfoque completamente reproducible en R para procesar los archivos de salida generados por un calorímetro de bomba Parr 6725.

El código:

-   asigna automáticamente los nombres de las columnas a los archivos de salida del calorímetro utilizando el archivo `RunDataTemplate.csv`,

-   integra todas las determinaciones individuales en un único conjunto de datos,

-   elimina variables no esenciales,

-   traduce los códigos binarios y numéricos a sus etiquetas descriptivas correspondientes, y

-   calcula valores de densidad energética con y sin corrección por contenido de cenizas.

## Description/ Descripción

### English

The Parr 6725 Calorimeter generates one output file per determination, with the `.det.finl.csv` extension and without column names.

This workflow is designed to operate in a universal and reproducible manner. Using the `RunDataTemplate.csv` file as a reference, the script assigns the appropriate column names and compiles all calorimetric determinations into a single dataset.

The code subsequently removes non-essential variables and converts binary and numeric codes from the calorimeter output into descriptive categorical values.

Finally, two energy density variables are calculate from the measured heat of combustion, HOC: `DE_kJ_g_DM` and `DE_kJ_g_AFDM`, which represent energy density (in kJ·g⁻¹) on a dry matter basis, without and with ash correction, respectively.

### Español

El Calorímetro Parr 6725 genera un archivo de salida por cada determinación, con la extensión `.det.finl.csv` y sin nombres en las columnas.

Este código está diseñado para funcionar de manera universal: a partir del archivo *"RunDataTemplate"*, asigna los nombres correspondientes a las columnas y luego compila un listado de todas las determinaciones realizadas.

Además, el código elimina las columnas que no son necesarias y reasigna los valores binarios a su definición correspondiente.

Por último, genera dos columnas denominadas **`DE_kJ_g_AFDM`** y **`DE_kJ_g_DM`**, que contienen los valores finales (calculados a partir del calor de combustión medido, HOC) de la densidad energética expresada en kilojoules por gramo de muestra seca, con y sin corrección por cenizas, respectivamente.

## Running assumptions

### English

-   The repository is opened as an R Project (`.Rproj` file).

-   All input files (`.det.finl.csv`, `Ashes.csv`, and `RunDataTemplate.csv`) must be stored in the `Determinations/` folder located at the root of the repository. This folder is empty when the repository is cloned.

-   The `Ashes.csv` file must be completed following these guidelines:

    -   **Sample ID**: must match the same ID assigned to the sample at the time of combustion.

    -   **Ashes_caps**: ash weight in grams after combustion, including the sample capsule.

    -   **Caps**: weight in grams of the empty capsule.

    -   **Ashes**: difference between `Ashes_caps` and `Caps`.

    -   **Spike_Ashes**: ash weight in grams of the vehicle (spike) used during combustion, **only when applicable**; otherwise, this field must be filled with `0`.

-   File paths are handled using the `here` package to ensure platform-independent execution.

### Español

-   El repositorio se abre como un proyecto de R (archivo `.Rproj`).

-   Todos los archivos de entrada (`.det.finl.csv`, `Ashes.csv` y `RunDataTemplate.csv`) deben guardarse en la carpeta `Determinations/` ubicada en la raíz del repositorio. Esta carpeta se encuentra intencionalmente vacía al clonar el repositorio.

-   El archivo `Ashes.csv` debe completarse siguiendo las siguientes pautas:

    -   **Sample ID**: debe coincidir con el ID asignado a la muestra al momento de la combustión.

    -   **Ashes_caps**: peso en gramos de las cenizas al finalizar la combustión, incluyendo la cápsula de soporte.

    -   **Caps**: peso en gramos de la cápsula soporte vacía.

    -   **Ashes**: diferencia entre `Ashes_caps` y `Caps`.

    -   **Spike_Ashes**: peso en gramos de las cenizas del vehículo (spike) utilizado durante la combustión, **solo en los casos en que se haya utilizado**; de lo contrario, completar con `0`.

-   Las rutas a los archivos se gestionan mediante el paquete `here`, garantizando una ejecución independiente del sistema operativo.

## Running Code in R/ Código completo en R

```{r, eval = FALSE}

library(readr)
library(dplyr)
library(here)

# Path to input files
# Ruta a los archivos de entrada
# The code assumes that all input files are stored in the "Determinations" folder
# at the root of the repository
# El código asume que todos los archivos de entrada están en la carpeta "Determinations"
# en la raíz del repositorio

path_ <- here("Determinations")

# Title templates / Plantilla de títulos
template_path <- file.path(path_, "RunDataTemplate.csv") 
header <- read_csv(template_path, n_max = 1) |> names()

# List .csv files, only determinations
# Listar los archivos .csv SOLO de las determinaciones
Determinations <- list.files(path_, pattern = "\\.csv", full.names = TRUE)
Determinations <- Determinations[!grepl("RunDataTemplate|Ashes", Determinations)]

Determinations_sh <- function(path) {
  read_csv(path, col_names = FALSE, skip = 0) %>% 
    setNames(header) %>% 
    mutate(archivo = basename(path))
}

# Delete unnecessary columns and redefine binary values from the equipment output
# Borra columnas innecesarias y reasigna valores binarios de la salida del equipo
Determinations_ <- Determinations %>%  
  lapply(Determinations_sh) %>%  
  bind_rows() %>% 
  select(-(c("Sulfur", "SulfurFinal","Hydrogen", "HydrogenFinal","MAD", "MADFinal",
             "UnitMultIfOther", "NetHOC", "<blank>", "DryNetHOC","Oxygen",
             "OxygenFinal","Nitrogen", "NitrogenFinal","MAR", "MARFinal",
             "ARNetHOC", "FuseFinal", "AcidFinal", "BombID"))) %>%  
  mutate(
    Mode = case_when(
      Mode == 1 ~ "Determination",
      Mode == 2 ~ "Standarization",
      TRUE ~ as.character(Mode)
    ),
    Method = case_when(
      Method == 1 ~ "Combustion",
      TRUE ~ as.character(Method)
    ),
    State = case_when(
      State == 0 ~ "Prepesado",
      State == 1 ~ "Preliminar",
      State == 2 ~ "Final",
      TRUE ~ as.character(State)
    ),
    Units = case_when(
      Units == 1 ~ "Btu/lb",
      Units == 2 ~ "cal/g", 
      Units == 3 ~ "J/g",
      TRUE ~ as.character(Units)
    )
  )

# Step to correct by ashes (kJ/g AFDM)
# Para corregir el valor de DE por cenizas y obtener kJ/g AFDM también
Ashes <- read_delim(file.path(path_, "Ashes.csv"), delim = ";")

Determinations_ <- Determinations_ %>%  
  left_join(
    Ashes %>% select(SampleID, Ashes, Spike_Ashes),
    by = "SampleID"
  )

Determinations__AshFree <- Determinations_ %>%
  mutate(DE_kJ_g_DM = as.numeric(HOC) * 0.004186) %>%
  mutate(
    HOC_corr = case_when(
      SpikeWt == 0 ~ ((BombEE * DeltaT) - (23 - (Fuse * 23 / 0.0145)) - Acid) /
        (SampleWt - Ashes),
      SpikeWt != 0 ~ (
        (((((BombEE * DeltaT) - (23 - (Fuse * 23 / 0.0145)) - Acid) /
             SampleWt) * (SampleWt - Ashes)) -
           (3186.128 * (SpikeWt - Spike_Ashes))) /
          (SampleWt - SpikeWt - Ashes)
      )
    )
  ) %>%
  mutate(DE_kJ_g_AFDM = as.numeric(HOC_corr) * 0.004186) %>%
  select(
    SampleID, archivo, Timestamp, BombEE, BombName, Mode, Method, State,
    Units, SpikeWt, SampleWt, JacketTemp, InitTemp, DeltaT, HOC, Fuse,
    Acid, Ashes, Spike_Ashes, HOC_corr, DE_kJ_g_DM, DE_kJ_g_AFDM, everything()
  )

View(Determinations__AshFree)
```

## Citation

If you use this workflow or parts of it in your research, please cite:

Fraysse, C., & Boy, C. (2026). *A reproducible R workflow for energy density estimation using a Parr 6725 bomb calorimeter*. GitHub repository: <https://github.com/cinGHub/POT-KEN-V1.3.0>

## Example Usage

For demonstration purposes, the repository includes an `Example/` folder containing a complete set of input files.

To run the workflow using the example data, temporarily set:

path\_ \<- here("Example")

```{r, eval = FALSE}
library(readr)
library(dplyr)
library(here)

path_ <- here("Example")


template_path <- file.path(path_, "RunDataTemplate.csv") 
header <- read_csv(template_path, n_max = 1) |> names()


Determinations <- list.files(path_, pattern = "\\.csv", full.names = TRUE)
Determinations <- Determinations[!grepl("RunDataTemplate|Ashes", Determinations)]

Determinations_sh <- function(path) {
  read_csv(path, col_names = FALSE, skip = 0) %>% 
    setNames(header) %>% 
    mutate(archivo = basename(path))
}

Determinations_ <- Determinations %>%  
  lapply(Determinations_sh) %>%  
  bind_rows() %>% 
  select(-(c("Sulfur", "SulfurFinal","Hydrogen", "HydrogenFinal","MAD", "MADFinal",
             "UnitMultIfOther", "NetHOC", "<blank>", "DryNetHOC","Oxygen",
             "OxygenFinal","Nitrogen", "NitrogenFinal","MAR", "MARFinal",
             "ARNetHOC", "FuseFinal", "AcidFinal", "BombID"))) %>%  
  mutate(
    Mode = case_when(
      Mode == 1 ~ "Determination",
      Mode == 2 ~ "Standarization",
      TRUE ~ as.character(Mode)
    ),
    Method = case_when(
      Method == 1 ~ "Combustion",
      TRUE ~ as.character(Method)
    ),
    State = case_when(
      State == 0 ~ "Prepesado",
      State == 1 ~ "Preliminar",
      State == 2 ~ "Final",
      TRUE ~ as.character(State)
    ),
    Units = case_when(
      Units == 1 ~ "Btu/lb",
      Units == 2 ~ "cal/g", 
      Units == 3 ~ "J/g",
      TRUE ~ as.character(Units)
    )
  )

Ashes <- read_delim(file.path(path_, "Ashes.csv"), delim = ";")

Determinations_ <- Determinations_ %>%  
  left_join(
    Ashes %>% select(SampleID, Ashes, Spike_Ashes),
    by = "SampleID"
  )

Determinations__AshFree <- Determinations_ %>%
  mutate(DE_kJ_g_DM = as.numeric(HOC) * 0.004186) %>%
  mutate(
    HOC_corr = case_when(
      SpikeWt == 0 ~ ((BombEE * DeltaT) - (23 - (Fuse * 23 / 0.0145)) - Acid) /
        (SampleWt - Ashes),
      SpikeWt != 0 ~ (
        (((((BombEE * DeltaT) - (23 - (Fuse * 23 / 0.0145)) - Acid) /
             SampleWt) * (SampleWt - Ashes)) -
           (3186.128 * (SpikeWt - Spike_Ashes))) /
          (SampleWt - SpikeWt - Ashes)
      )
    )
  ) %>%
  mutate(DE_kJ_g_AFDM = as.numeric(HOC_corr) * 0.004186) %>%
  select(
    SampleID, archivo, Timestamp, BombEE, BombName, Mode, Method, State,
    Units, SpikeWt, SampleWt, JacketTemp, InitTemp, DeltaT, HOC, Fuse,
    Acid, Ashes, Spike_Ashes, HOC_corr, DE_kJ_g_DM, DE_kJ_g_AFDM, everything()
  )

View(Determinations__AshFree)
```
